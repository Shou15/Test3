@page "/EditApartment/{apartmentId}"
@using Test3.Data.Models
@using Test3.Data.Services
@inject ApartmentService ApartmentService
@inject RoomService RoomService
@inject ImageService ImageService
@inject NavigationManager Navigation
@inject LeaseService LeaseService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<div class="edit-container">
    <!-- Your existing header and apartment form sections remain the same -->
    <div class="header">
        <button class="back-btn" @onclick="GoBack">←</button>
        <h2>EDIT APARTMENT</h2>
    </div>

    @if (isLoading)
    {
        <div class="loading">Loading apartment data...</div>
    }
    else if (apartment == null)
    {
        <div class="error">Apartment not found.</div>
        <button class="back-btn" @onclick="GoBack">Go Back</button>
    }
    else
    {
        <div class="form-grid">
            <!-- Your existing apartment form fields -->
            <div>
                <label>Apartment Name:</label>
                <input @bind="apartment.ApartmentName" class="text-input" placeholder="Enter apartment name" />
            </div>
            <div>
                <label>Address:</label>
                <input @bind="apartment.Address" class="text-input" placeholder="Enter full address" />
            </div>
            <div>
                <label>Email Address:</label>
                <input @bind="apartment.EmailAddress" class="text-input" placeholder="Enter email address" />
            </div>
            <div>
                <label>Apartment Owner:</label>
                <input @bind="apartment.ApartmentOwner" class="text-input" placeholder="Enter owner name" />
            </div>
            <div>
                <label>Contact Number:</label>
                <input @bind="apartment.ContactNo" class="text-input" placeholder="Enter contact number" />
            </div>
            <div>
                <label>Facebook Account:</label>
                <input @bind="apartment.FacebookAccount" class="text-input" placeholder="Enter Facebook account" />
            </div>
        </div>

        <!-- Your existing apartment image upload section -->
        <div class="image-upload">
            <p><b>Apartment Image</b></p>
            @if (!string.IsNullOrEmpty(currentImageSrc))
            {
                <div class="image-preview">
                    <img src="@currentImageSrc" alt="Apartment image" class="preview-image" />
                    <button type="button" class="remove-image-btn" @onclick="RemoveImage">Remove Image</button>
                </div>
            }
            <div class="file-upload-area">
                <InputFile accept=".png,.jpg,.jpeg"
                           OnChange="HandleFileSelected"
                           class="file-input"
                           id="fileInput" />
                <label for="fileInput" class="file-input-label">
                    <span>+ Choose Image (PNG, JPG, JPEG)</span>
                </label>
                @if (selectedFile != null)
                {
                    <div class="file-info">
                        <span>Selected: @selectedFile.Name</span>
                        <button type="button" @onclick="ClearSelectedFile">Clear</button>
                    </div>
                }
            </div>
            @if (!string.IsNullOrEmpty(uploadMessage))
            {
                <div class="upload-message @(isUploadError ? "error" : "info")">@uploadMessage</div>
            }
        </div>

        <!-- Units Management Section -->
        <div class="units-header">
            <div><b>Total Units:</b> @rooms.Count</div>
            <div><b>Available:</b> @rooms.Count(r => r.Status == "Available")</div>
            <div><b>Occupied:</b> @rooms.Count(r => r.Status == "Occupied")</div>
            <div><button style="color: #595858" class="add-unit-btn" @onclick="AddNewUnit">+ Add unit</button></div>
        </div>

        <div class="unit-list">
            @if (rooms.Any())
            {
                @foreach (var room in rooms)
                {
                    <div class="unit-card" @key="room.Id">
                        <!-- Stacked Image Preview -->
                        <div class="unit-image-stack">
                            @if (room.Images.Any())
                            {
                                <div class="stacked-thumbnails" @onclick="() => ViewUnitImages(room)">
                                    @foreach (var image in room.Images.Take(3))
                                    {
                                        <img src="@ImageService.GetImageSrc(image.ImageData, image.ImageContentType)"
                                             alt="Room image"
                                             class="thumbnail" />
                                    }
                                    @if (room.Images.Count > 3)
                                    {
                                        <div class="thumbnail-count">+@(room.Images.Count - 3)</div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="unit-image-placeholder" @onclick="() => ViewUnitImages(room)">
                                    <span>No Images</span>
                                </div>
                            }
                        </div>
                        <div class="unit-details">
                            <h4>@room.UnitNumber</h4>
                            <p><strong>Type:</strong> @room.RoomType</p>
                            <p><strong>Rent:</strong> ₱@room.RoomPrice.ToString("N2")</p>
                            <p><strong>Beds:</strong> @room.BedCount</p>
                            <p><strong>Aircon:</strong> @(room.Aircon ? "Yes" : "No")</p>
                            <p><strong>Status:</strong> <span class="status-@room.Status.ToLower()">@room.Status</span></p>

                            <!-- Add tenant name display for occupied units -->
                            @if (room.Status == "Occupied")
                            {
                                <p><strong>Tenant:</strong> @GetTenantNameForUnit(room.UnitNumber)</p>
                            }
                            else
                            {
                                <p><strong>Tenant:</strong> None</p>
                            }
                        </div>
                        <div class="unit-actions">
                            <button class="edit-unit-btn" @onclick="() => EditUnit(room)">Edit Unit</button>
                            <button class="delete-unit-btn" @onclick="() => ShowDeleteConfirmation(room)">Delete</button>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="no-units">
                    <p>No units added yet.</p>
                    <p>Click "Add unit" to create your first unit.</p>
                </div>
            }
        </div>

        <div class="footer-actions">
            <button class="save-btn" @onclick="SaveApartment" disabled="@isSaving">
                @if (isSaving)
                {
                    <span>Saving...</span>
                }
                else
                {
                    <span>Save Apartment</span>
                }
            </button>
            @if (!string.IsNullOrEmpty(saveMessage))
            {
                <div class="save-message @(isError ? "error" : "success")">@saveMessage</div>
            }
        </div>
    }
</div>

<!-- Delete Confirmation Modal -->
@if (showDeleteModal)
{
    <div class="modal-overlay visible">
        <div class="modal-content delete-modal">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <button class="close-btn" @onclick="CancelDelete">×</button>
            </div>
            <div class="modal-body">
                <div class="warning-icon">⚠️</div>
                <p>Are you sure you want to delete unit <strong>@unitToDelete?.UnitNumber</strong>?</p>
                <p class="warning-text">This action cannot be undone and will permanently delete the unit and all its data.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="CancelDelete" disabled="@isDeleting">Cancel</button>
                <button class="btn-delete" @onclick="ConfirmDelete" disabled="@isDeleting">
                    @if (isDeleting)
                    {
                        <span>Deleting...</span>
                    }
                    else
                    {
                        <span>Delete Unit</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

<!-- Unit Images Gallery Modal -->
@if (showImagesModal && selectedRoomForImages != null)
{
    <div class="gallery-modal" @onclick="CloseImagesModal">
        <div class="gallery-content" @onclick:stopPropagation="true">
            <button class="gallery-close" @onclick="CloseImagesModal">×</button>

            <h3>Unit @selectedRoomForImages.UnitNumber - Images</h3>

            @if (selectedRoomForImages.Images.Any())
            {
                <div class="gallery-main-image">
                    <img src="@ImageService.GetImageSrc(selectedRoomForImages.Images[currentImageIndex].ImageData, selectedRoomForImages.Images[currentImageIndex].ImageContentType)"
                         alt="Unit image @(currentImageIndex + 1)" />
                </div>

                <div class="gallery-controls">
                    <button class="gallery-nav gallery-prev" @onclick="PreviousImage"
                            disabled="@(currentImageIndex == 0)">
                        ‹
                    </button>

                    <div class="gallery-counter">
                        @(currentImageIndex + 1) / @selectedRoomForImages.Images.Count
                    </div>

                    <button class="gallery-nav gallery-next" @onclick="NextImage"
                            disabled="@(currentImageIndex == selectedRoomForImages.Images.Count - 1)">
                        ›
                    </button>
                </div>

                <div class="gallery-thumbnails">
                    @for (int i = 0; i < selectedRoomForImages.Images.Count; i++)
                    {
                        <img src="@ImageService.GetImageSrc(selectedRoomForImages.Images[i].ImageData, selectedRoomForImages.Images[i].ImageContentType)"
                             class="@(i == currentImageIndex ? "thumbnail-active" : "")"
                             @onclick="() => SetCurrentImage(i)"
                             alt="Thumbnail @(i + 1)" />
                    }
                </div>
            }
            else
            {
                <div class="no-images">No images available for this unit.</div>
            }
        </div>
    </div>
}

<!-- Edit Unit Modal -->
@if (showUnitModal)
{
    <EditUnitModal @bind-IsVisible="showUnitModal"
                   Room="selectedRoom"
                   ApartmentId="@ApartmentId"
                   OnUnitSaved="HandleUnitSaved" />
}

@code {
    [Parameter]
    public string ApartmentId { get; set; } = string.Empty;

    [Parameter]
    [SupplyParameterFromQuery(Name = "landlordId")]
    public string? LandlordId { get; set; }

    private Apartment? apartment;
    private List<Room> rooms = new();
    private bool isLoading = true;
    private bool isSaving = false;
    private string saveMessage = "";
    private bool isError = false;
    private string currentImageSrc = "";
    private IBrowserFile? selectedFile;
    private string uploadMessage = "";
    private bool isUploadError = false;

    // Unit Management
    private bool showUnitModal = false;
    private Room? selectedRoom = null;

    // Delete Confirmation
    private bool showDeleteModal = false;
    private Room? unitToDelete = null;
    private bool isDeleting = false;

    // Images Modal
    private bool showImagesModal = false;
    private Room? selectedRoomForImages = null;

    // Gallery state
    private int currentImageIndex = 0;

    private Dictionary<string, string> unitTenantMapping = new();

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(ApartmentId))
        {
            await LoadApartment();
            await LoadTenantNames(); // Add this line
        }
        else
        {
            isLoading = false;
        }
    }

    private async Task LoadTenantNames()
    {
        try
        {
            var leases = await LeaseService.GetLeasesByLandlordAsync(LandlordId);
            unitTenantMapping = leases
                .Where(l => l.IsActive)
                .ToDictionary(l => l.UnitNumber, l => l.FullName);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tenant names: {ex.Message}");
        }
    }

    private string GetTenantNameForUnit(string unitNumber)
    {
        return unitTenantMapping.ContainsKey(unitNumber)
            ? unitTenantMapping[unitNumber]
            : "Not assigned";
    }

    private async Task LoadApartment()
    {
        isLoading = true;
        try
        {
            apartment = await ApartmentService.GetApartmentByIdAsync(ApartmentId);
            if (apartment != null)
            {
                rooms = await RoomService.GetRoomsByApartmentIdAsync(ApartmentId);

                if (apartment?.ImageData != null)
                {
                    currentImageSrc = ImageService.GetImageSrc(apartment.ImageData, apartment.ImageContentType);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading apartment: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void AddNewUnit()
    {
        try
        {
            // Just open the modal without creating any temporary objects
            selectedRoom = null; // This indicates we're creating a new room
            showUnitModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding unit: {ex.Message}");
        }
    }

    private void EditUnit(Room room)
    {
        selectedRoom = room;
        showUnitModal = true;
        StateHasChanged();
    }

    private void ShowDeleteConfirmation(Room room)
    {
        unitToDelete = room;
        showDeleteModal = true;
        StateHasChanged();
    }

    private void CancelDelete()
    {
        showDeleteModal = false;
        unitToDelete = null;
        isDeleting = false;
        StateHasChanged();
    }

    private async Task ConfirmDelete()
    {
        if (unitToDelete == null) return;

        isDeleting = true;
        StateHasChanged();

        try
        {
            await RoomService.DeleteRoomAsync(unitToDelete.Id);

            // Remove from local list
            rooms.RemoveAll(r => r.Id == unitToDelete.Id);

            showDeleteModal = false;
            unitToDelete = null;

            // Show success message
            saveMessage = "Unit deleted successfully!";
            isError = false;

            StateHasChanged();

            // Clear success message after delay
            await Task.Delay(2000);
            saveMessage = "";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            saveMessage = "Error deleting unit. Please try again.";
            isError = true;
            Console.WriteLine($"Error deleting unit: {ex.Message}");
        }
        finally
        {
            isDeleting = false;
            StateHasChanged();
        }
    }

    private void ViewUnitImages(Room room)
    {
        selectedRoomForImages = room;
        currentImageIndex = 0; // Reset to first image
        showImagesModal = true;
        StateHasChanged();
    }

    private void CloseImagesModal()
    {
        showImagesModal = false;
        selectedRoomForImages = null;
        currentImageIndex = 0;
        StateHasChanged();
    }

    // Gallery navigation methods
    private void NextImage()
    {
        if (selectedRoomForImages != null && currentImageIndex < selectedRoomForImages.Images.Count - 1)
        {
            currentImageIndex++;
            StateHasChanged();
        }
    }

    private void PreviousImage()
    {
        if (selectedRoomForImages != null && currentImageIndex > 0)
        {
            currentImageIndex--;
            StateHasChanged();
        }
    }

    private void SetCurrentImage(int index)
    {
        currentImageIndex = index;
        StateHasChanged();
    }

    private async Task HandleUnitSaved(Room savedRoom)
    {
        // Refresh the entire list from database to include the new room
        await LoadApartment();
        StateHasChanged();
    }

    // Your existing methods remain the same
    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        uploadMessage = "";
        isUploadError = false;
        StateHasChanged();
    }

    private void ClearSelectedFile()
    {
        selectedFile = null;
        uploadMessage = "";
        StateHasChanged();
    }

    private void RemoveImage()
    {
        if (apartment != null)
        {
            apartment.ImageData = null;
            apartment.ImageContentType = "";
            apartment.ImageFileName = "";
            currentImageSrc = "";
            StateHasChanged();
        }
    }

    private async Task SaveApartment()
    {
        if (apartment == null) return;

        isSaving = true;
        saveMessage = "";
        isError = false;
        StateHasChanged();

        try
        {
            if (selectedFile != null)
            {
                try
                {
                    var (imageData, contentType, fileName) = await ImageService.ProcessUploadAsync(selectedFile);
                    apartment.ImageData = imageData;
                    apartment.ImageContentType = contentType;
                    apartment.ImageFileName = fileName;
                    uploadMessage = "Image processed successfully!";
                    isUploadError = false;
                }
                catch (Exception ex)
                {
                    uploadMessage = ex.Message;
                    isUploadError = true;
                    isSaving = false;
                    StateHasChanged();
                    return;
                }
            }

            await ApartmentService.UpdateApartmentAsync(apartment.Id, apartment);
            saveMessage = "Apartment saved successfully!";
            isError = false;

            await Task.Delay(1000);
            GoBack();
        }
        catch (Exception ex)
        {
            saveMessage = "Error saving apartment. Please try again.";
            isError = true;
            Console.WriteLine($"Error saving apartment: {ex.Message}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private void GoBack()
    {
        if (!string.IsNullOrEmpty(LandlordId))
        {
            Navigation.NavigateTo($"/ManageApartment?landlordId={LandlordId}");
        }
        else
        {
            Navigation.NavigateTo("/ManageApartment");
        }
    }
}